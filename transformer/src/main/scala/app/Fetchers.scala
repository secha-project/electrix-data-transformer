package app

import org.apache.spark.sql.{DataFrame, SparkSession}
import org.apache.spark.sql.functions.{col, lit}
import org.apache.spark.sql.types.{IntegerType, DoubleType, LongType, StringType}


object Fetchers {
    def getDevices(spark: SparkSession, inputPath: String): List[Long] = {
        import spark.implicits.newLongEncoder

        spark
            .read
            .schema(Schemas.deviceSchema)
            .option("header", true)
            .option("delimiter", ",")
            .csv(inputPath)
            .select("id")
            .as[Long]
            .collect()
            .toList
    }

    def getData(spark: SparkSession, inputPath: String): DataFrame = {
        spark
            .read
            .schema(Schemas.dataSchema)
            .option("header", true)
            .option("delimiter", ",")
            .csv(inputPath)
            .select(
                col("meter").alias("device_id"),
                col("timestamp"),
                lit(null).cast(LongType).alias("event_id"),
                col("fhz"),
                col("pw"),
                col("qfryzevar"),
                col("q1var"),
                col("pl1w"),
                col("pl2w"),
                col("pl3w"),
                col("p1l1"),
                col("p1l2"),
                col("p1l3"),
                col("qfryzel1var"),
                col("qfryzel2var"),
                col("qfryzel3var"),
                col("q1l1"),
                col("q1l2"),
                col("q1l3"),
                col("sva"),
                col("sl1va"),
                col("sl2va"),
                col("sl3va"),
                col("s1l1"),
                col("s1l2"),
                col("s1l3"),
                col("ul1v"),
                col("ul2v"),
                col("ul3v"),
                col("ul12v"),
                col("ul23v"),
                col("ul31v"),
                col("il1a"),
                col("il2a"),
                col("il3a"),
                col("i_n"),
                col("tdil1"),
                col("tdil2"),
                col("tdil3"),
                col("u1l1"),
                col("u3l1"),
                col("u5l1"),
                col("u7l1"),
                col("u9l1"),
                col("u11l1"),
                col("u13l1"),
                col("u15l1"),
                col("u17l1"),
                col("u19l1"),
                col("u21l1"),
                col("u23l1"),
                col("u25l1"),
                col("u27l1"),
                col("u29l1"),
                col("u31l1"),
                col("u33l1"),
                col("u35l1"),
                col("u37l1"),
                col("u39l1"),
                col("u1l2"),
                col("u3l2"),
                col("u5l2"),
                col("u7l2"),
                col("u9l2"),
                col("u11l2"),
                col("u13l2"),
                col("u15l2"),
                col("u17l2"),
                col("u19l2"),
                col("u21l2"),
                col("u23l2"),
                col("u25l2"),
                col("u27l2"),
                col("u29l2"),
                col("u31l2"),
                col("u33l2"),
                col("u35l2"),
                col("u37l2"),
                col("u39l2"),
                col("u1l3"),
                col("u3l3"),
                col("u5l3"),
                col("u7l3"),
                col("u9l3"),
                col("u11l3"),
                col("u13l3"),
                col("u15l3"),
                col("u17l3"),
                col("u19l3"),
                col("u21l3"),
                col("u23l3"),
                col("u25l3"),
                col("u27l3"),
                col("u29l3"),
                col("u31l3"),
                col("u33l3"),
                col("u35l3"),
                col("u37l3"),
                col("u39l3"),
                col("i1l1"),
                col("i3l1"),
                col("i5l1"),
                col("i7l1"),
                col("i9l1"),
                col("i11l1"),
                col("i13l1"),
                col("i15l1"),
                col("i17l1"),
                col("i19l1"),
                col("i21l1"),
                col("i23l1"),
                col("i25l1"),
                col("i27l1"),
                col("i29l1"),
                col("i31l1"),
                col("i33l1"),
                col("i35l1"),
                col("i37l1"),
                col("i39l1"),
                col("i1l2"),
                col("i3l2"),
                col("i5l2"),
                col("i7l2"),
                col("i9l2"),
                col("i11l2"),
                col("i13l2"),
                col("i15l2"),
                col("i17l2"),
                col("i19l2"),
                col("i21l2"),
                col("i23l2"),
                col("i25l2"),
                col("i27l2"),
                col("i29l2"),
                col("i31l2"),
                col("i33l2"),
                col("i35l2"),
                col("i37l2"),
                col("i39l2"),
                col("i1l3"),
                col("i3l3"),
                col("i5l3"),
                col("i7l3"),
                col("i9l3"),
                col("i11l3"),
                col("i13l3"),
                col("i15l3"),
                col("i17l3"),
                col("i19l3"),
                col("i21l3"),
                col("i23l3"),
                col("i25l3"),
                col("i27l3"),
                col("i29l3"),
                col("i31l3"),
                col("i33l3"),
                col("i35l3"),
                col("i37l3"),
                col("i39l3"),
                col("u2u1"),
                col("u0u1"),
                col("udcl1"),
                col("udcl2"),
                col("udcl3"),
                col("idcl1"),
                col("idcl2"),
                col("idcl3"),
                col("idcn"),
                col("t1"),
                col("t2"),
                col("t3"),
                col("t4"),
                col("udcl12"),
                col("udcl23"),
                col("udcl31"),
                col("pfl1"),
                col("pfl2"),
                col("pfl3"),
                col("dpfl1"),
                col("dpfl2"),
                col("dpfl3"),
                col("udevl1"),
                col("udevl2"),
                col("udevl3"),
                col("odevl1"),
                col("odevl2"),
                col("odevl3"),
                col("umaxl12"),
                col("umaxl23"),
                col("umaxl31"),
                col("umaxl1v"),
                col("umaxl2v"),
                col("umaxl3v"),
                col("imaxl1a"),
                col("imaxl2a"),
                col("imaxl3a"),
                col("imaxn"),
                col("dmax"),
                col("tdimax"),
                col("u2u1max"),
                col("u0u1max"),
                col("uminl1v"),
                col("uminl2v"),
                col("uminl3v"),
                col("iminl1a"),
                col("iminl2a"),
                col("iminl3a"),
                col("uminl12"),
                col("uminl23"),
                col("uminl31"),
                col("pfmin"),
                col("dpfmin"),
                col("pstl1"),
                col("pstl2"),
                col("pstl3"),
                col("jd"),
                col("js"),
                col("jus"),
                col("rec_source"),
                col("io"),
                col("flagged"),
                col("periods"),
                col("samples"),
                col("calc_t"),
                col("m0peak_t"),
                col("crc_status"),
                col("io1"),
                col("io2"),
                col("io3"),
                col("io4"),
                col("io5"),
                col("io6"),
                col("io7"),
                col("io8"),
                col("ep10wh"),
                col("ep_10wh"),
                col("eq10varh"),
                col("eq_10varh"),
                col("eq1_pos"),
                col("eq1_neg"),
                col("rec_no"),
                col("dl1"),
                col("dl2"),
                col("dl3"),
            )
    }

    def checkEventData(spark: SparkSession, inputPath: String): Boolean = {
        val event_data_columns: Int = spark
            .read
            .csv(inputPath)
            .columns
            .length
        event_data_columns == Schemas.eventDataSchema.fields.length
    }

    def getEventData(spark: SparkSession, inputPath: String): DataFrame = {
        spark
            .read
            .schema(Schemas.eventDataSchema)
            .option("header", true)
            .option("delimiter", ",")
            .csv(inputPath)
            .select(
                col("meter").alias("device_id"),
                col("timestamp"),
                col("event_id"),
                col("freq").alias("fhz"),
                lit(null).cast(DoubleType).alias("pw"),
                lit(null).cast(DoubleType).alias("qfryzevar"),
                lit(null).cast(DoubleType).alias("q1var"),
                lit(null).cast(DoubleType).alias("pl1w"),
                lit(null).cast(DoubleType).alias("pl2w"),
                lit(null).cast(DoubleType).alias("pl3w"),
                col("P1L1").alias("p1l1"),
                col("P1L2").alias("p1l2"),
                col("P1L3").alias("p1l3"),
                lit(null).cast(DoubleType).alias("qfryzel1var"),
                lit(null).cast(DoubleType).alias("qfryzel2var"),
                lit(null).cast(DoubleType).alias("qfryzel3var"),
                col("Q1L1").alias("q1l1"),
                col("Q1L2").alias("q1l2"),
                col("Q1L3").alias("q1l3"),
                lit(null).cast(DoubleType).alias("sva"),
                lit(null).cast(DoubleType).alias("sl1va"),
                lit(null).cast(DoubleType).alias("sl2va"),
                lit(null).cast(DoubleType).alias("sl3va"),
                lit(null).cast(DoubleType).alias("s1l1"),
                lit(null).cast(DoubleType).alias("s1l2"),
                lit(null).cast(DoubleType).alias("s1l3"),
                col("UL1").alias("ul1v"),
                col("UL2").alias("ul2v"),
                col("UL3").alias("ul3v"),
                col("U12").alias("ul12v"),
                col("U23").alias("ul23v"),
                col("U31").alias("ul31v"),
                col("IL1").alias("il1a"),
                col("IL2").alias("il2a"),
                col("IL3").alias("il3a"),
                col("IN").alias("i_n"),
                col("TDIL1").alias("tdil1"),
                col("TDIL2").alias("tdil2"),
                col("TDIL3").alias("tdil3"),
                lit(null).cast(DoubleType).alias("u1l1"),
                lit(null).cast(DoubleType).alias("u3l1"),
                lit(null).cast(DoubleType).alias("u5l1"),
                lit(null).cast(DoubleType).alias("u7l1"),
                lit(null).cast(DoubleType).alias("u9l1"),
                lit(null).cast(DoubleType).alias("u11l1"),
                lit(null).cast(DoubleType).alias("u13l1"),
                lit(null).cast(DoubleType).alias("u15l1"),
                lit(null).cast(DoubleType).alias("u17l1"),
                lit(null).cast(DoubleType).alias("u19l1"),
                lit(null).cast(DoubleType).alias("u21l1"),
                lit(null).cast(DoubleType).alias("u23l1"),
                lit(null).cast(DoubleType).alias("u25l1"),
                lit(null).cast(DoubleType).alias("u27l1"),
                lit(null).cast(DoubleType).alias("u29l1"),
                lit(null).cast(DoubleType).alias("u31l1"),
                lit(null).cast(DoubleType).alias("u33l1"),
                lit(null).cast(DoubleType).alias("u35l1"),
                lit(null).cast(DoubleType).alias("u37l1"),
                lit(null).cast(DoubleType).alias("u39l1"),
                lit(null).cast(DoubleType).alias("u1l2"),
                lit(null).cast(DoubleType).alias("u3l2"),
                lit(null).cast(DoubleType).alias("u5l2"),
                lit(null).cast(DoubleType).alias("u7l2"),
                lit(null).cast(DoubleType).alias("u9l2"),
                lit(null).cast(DoubleType).alias("u11l2"),
                lit(null).cast(DoubleType).alias("u13l2"),
                lit(null).cast(DoubleType).alias("u15l2"),
                lit(null).cast(DoubleType).alias("u17l2"),
                lit(null).cast(DoubleType).alias("u19l2"),
                lit(null).cast(DoubleType).alias("u21l2"),
                lit(null).cast(DoubleType).alias("u23l2"),
                lit(null).cast(DoubleType).alias("u25l2"),
                lit(null).cast(DoubleType).alias("u27l2"),
                lit(null).cast(DoubleType).alias("u29l2"),
                lit(null).cast(DoubleType).alias("u31l2"),
                lit(null).cast(DoubleType).alias("u33l2"),
                lit(null).cast(DoubleType).alias("u35l2"),
                lit(null).cast(DoubleType).alias("u37l2"),
                lit(null).cast(DoubleType).alias("u39l2"),
                lit(null).cast(DoubleType).alias("u1l3"),
                lit(null).cast(DoubleType).alias("u3l3"),
                lit(null).cast(DoubleType).alias("u5l3"),
                lit(null).cast(DoubleType).alias("u7l3"),
                lit(null).cast(DoubleType).alias("u9l3"),
                lit(null).cast(DoubleType).alias("u11l3"),
                lit(null).cast(DoubleType).alias("u13l3"),
                lit(null).cast(DoubleType).alias("u15l3"),
                lit(null).cast(DoubleType).alias("u17l3"),
                lit(null).cast(DoubleType).alias("u19l3"),
                lit(null).cast(DoubleType).alias("u21l3"),
                lit(null).cast(DoubleType).alias("u23l3"),
                lit(null).cast(DoubleType).alias("u25l3"),
                lit(null).cast(DoubleType).alias("u27l3"),
                lit(null).cast(DoubleType).alias("u29l3"),
                lit(null).cast(DoubleType).alias("u31l3"),
                lit(null).cast(DoubleType).alias("u33l3"),
                lit(null).cast(DoubleType).alias("u35l3"),
                lit(null).cast(DoubleType).alias("u37l3"),
                lit(null).cast(DoubleType).alias("u39l3"),
                lit(null).cast(DoubleType).alias("i1l1"),
                lit(null).cast(DoubleType).alias("i3l1"),
                lit(null).cast(DoubleType).alias("i5l1"),
                lit(null).cast(DoubleType).alias("i7l1"),
                lit(null).cast(DoubleType).alias("i9l1"),
                lit(null).cast(DoubleType).alias("i11l1"),
                lit(null).cast(DoubleType).alias("i13l1"),
                lit(null).cast(DoubleType).alias("i15l1"),
                lit(null).cast(DoubleType).alias("i17l1"),
                lit(null).cast(DoubleType).alias("i19l1"),
                lit(null).cast(DoubleType).alias("i21l1"),
                lit(null).cast(DoubleType).alias("i23l1"),
                lit(null).cast(DoubleType).alias("i25l1"),
                lit(null).cast(DoubleType).alias("i27l1"),
                lit(null).cast(DoubleType).alias("i29l1"),
                lit(null).cast(DoubleType).alias("i31l1"),
                lit(null).cast(DoubleType).alias("i33l1"),
                lit(null).cast(DoubleType).alias("i35l1"),
                lit(null).cast(DoubleType).alias("i37l1"),
                lit(null).cast(DoubleType).alias("i39l1"),
                lit(null).cast(DoubleType).alias("i1l2"),
                lit(null).cast(DoubleType).alias("i3l2"),
                lit(null).cast(DoubleType).alias("i5l2"),
                lit(null).cast(DoubleType).alias("i7l2"),
                lit(null).cast(DoubleType).alias("i9l2"),
                lit(null).cast(DoubleType).alias("i11l2"),
                lit(null).cast(DoubleType).alias("i13l2"),
                lit(null).cast(DoubleType).alias("i15l2"),
                lit(null).cast(DoubleType).alias("i17l2"),
                lit(null).cast(DoubleType).alias("i19l2"),
                lit(null).cast(DoubleType).alias("i21l2"),
                lit(null).cast(DoubleType).alias("i23l2"),
                lit(null).cast(DoubleType).alias("i25l2"),
                lit(null).cast(DoubleType).alias("i27l2"),
                lit(null).cast(DoubleType).alias("i29l2"),
                lit(null).cast(DoubleType).alias("i31l2"),
                lit(null).cast(DoubleType).alias("i33l2"),
                lit(null).cast(DoubleType).alias("i35l2"),
                lit(null).cast(DoubleType).alias("i37l2"),
                lit(null).cast(DoubleType).alias("i39l2"),
                lit(null).cast(DoubleType).alias("i1l3"),
                lit(null).cast(DoubleType).alias("i3l3"),
                lit(null).cast(DoubleType).alias("i5l3"),
                lit(null).cast(DoubleType).alias("i7l3"),
                lit(null).cast(DoubleType).alias("i9l3"),
                lit(null).cast(DoubleType).alias("i11l3"),
                lit(null).cast(DoubleType).alias("i13l3"),
                lit(null).cast(DoubleType).alias("i15l3"),
                lit(null).cast(DoubleType).alias("i17l3"),
                lit(null).cast(DoubleType).alias("i19l3"),
                lit(null).cast(DoubleType).alias("i21l3"),
                lit(null).cast(DoubleType).alias("i23l3"),
                lit(null).cast(DoubleType).alias("i25l3"),
                lit(null).cast(DoubleType).alias("i27l3"),
                lit(null).cast(DoubleType).alias("i29l3"),
                lit(null).cast(DoubleType).alias("i31l3"),
                lit(null).cast(DoubleType).alias("i33l3"),
                lit(null).cast(DoubleType).alias("i35l3"),
                lit(null).cast(DoubleType).alias("i37l3"),
                lit(null).cast(DoubleType).alias("i39l3"),
                col("U2/U1").alias("u2u1"),
                col("U0/U1").alias("u0u1"),
                lit(null).cast(DoubleType).alias("udcl1"),
                lit(null).cast(DoubleType).alias("udcl2"),
                lit(null).cast(DoubleType).alias("udcl3"),
                lit(null).cast(DoubleType).alias("idcl1"),
                lit(null).cast(DoubleType).alias("idcl2"),
                lit(null).cast(DoubleType).alias("idcl3"),
                lit(null).cast(DoubleType).alias("idcn"),
                lit(null).cast(DoubleType).alias("t1"),
                lit(null).cast(DoubleType).alias("t2"),
                lit(null).cast(DoubleType).alias("t3"),
                lit(null).cast(DoubleType).alias("t4"),
                lit(null).cast(DoubleType).alias("udcl12"),
                lit(null).cast(DoubleType).alias("udcl23"),
                lit(null).cast(DoubleType).alias("udcl31"),
                lit(null).cast(DoubleType).alias("pfl1"),
                lit(null).cast(DoubleType).alias("pfl2"),
                lit(null).cast(DoubleType).alias("pfl3"),
                col("DPFL1").alias("dpfl1"),
                col("DPFL2").alias("dpfl2"),
                col("DPFL3").alias("dpfl3"),
                lit(null).cast(DoubleType).alias("udevl1"),
                lit(null).cast(DoubleType).alias("udevl2"),
                lit(null).cast(DoubleType).alias("udevl3"),
                lit(null).cast(DoubleType).alias("odevl1"),
                lit(null).cast(DoubleType).alias("odevl2"),
                lit(null).cast(DoubleType).alias("odevl3"),
                lit(null).cast(DoubleType).alias("umaxl12"),
                lit(null).cast(DoubleType).alias("umaxl23"),
                lit(null).cast(DoubleType).alias("umaxl31"),
                lit(null).cast(DoubleType).alias("umaxl1v"),
                lit(null).cast(DoubleType).alias("umaxl2v"),
                lit(null).cast(DoubleType).alias("umaxl3v"),
                lit(null).cast(DoubleType).alias("imaxl1a"),
                lit(null).cast(DoubleType).alias("imaxl2a"),
                lit(null).cast(DoubleType).alias("imaxl3a"),
                lit(null).cast(DoubleType).alias("imaxn"),
                lit(null).cast(DoubleType).alias("dmax"),
                lit(null).cast(DoubleType).alias("tdimax"),
                lit(null).cast(DoubleType).alias("u2u1max"),
                lit(null).cast(DoubleType).alias("u0u1max"),
                lit(null).cast(DoubleType).alias("uminl1v"),
                lit(null).cast(DoubleType).alias("uminl2v"),
                lit(null).cast(DoubleType).alias("uminl3v"),
                lit(null).cast(DoubleType).alias("iminl1a"),
                lit(null).cast(DoubleType).alias("iminl2a"),
                lit(null).cast(DoubleType).alias("iminl3a"),
                lit(null).cast(DoubleType).alias("uminl12"),
                lit(null).cast(DoubleType).alias("uminl23"),
                lit(null).cast(DoubleType).alias("uminl31"),
                lit(null).cast(DoubleType).alias("pfmin"),
                lit(null).cast(DoubleType).alias("dpfmin"),
                lit(null).cast(DoubleType).alias("pstl1"),
                lit(null).cast(DoubleType).alias("pstl2"),
                lit(null).cast(DoubleType).alias("pstl3"),
                lit(null).cast(IntegerType).alias("jd"),
                lit(null).cast(IntegerType).alias("js"),
                lit(null).cast(IntegerType).alias("jus"),
                lit(null).cast(StringType).alias("rec_source"),
                lit(null).cast(StringType).alias("io"),
                lit(null).cast(StringType).alias("flagged"),
                lit(null).cast(IntegerType).alias("periods"),
                lit(null).cast(IntegerType).alias("samples"),
                lit(null).cast(IntegerType).alias("calc_t"),
                lit(null).cast(IntegerType).alias("m0peak_t"),
                lit(null).cast(StringType).alias("crc_status"),
                lit(null).cast(IntegerType).alias("io1"),
                lit(null).cast(IntegerType).alias("io2"),
                lit(null).cast(IntegerType).alias("io3"),
                lit(null).cast(IntegerType).alias("io4"),
                lit(null).cast(IntegerType).alias("io5"),
                lit(null).cast(IntegerType).alias("io6"),
                lit(null).cast(IntegerType).alias("io7"),
                lit(null).cast(IntegerType).alias("io8"),
                lit(null).cast(DoubleType).alias("ep10wh"),
                lit(null).cast(DoubleType).alias("ep_10wh"),
                lit(null).cast(DoubleType).alias("eq10varh"),
                lit(null).cast(DoubleType).alias("eq_10varh"),
                lit(null).cast(DoubleType).alias("eq1_pos"),
                lit(null).cast(DoubleType).alias("eq1_neg"),
                lit(null).cast(IntegerType).alias("rec_no"),
                col("TDUL1").alias("dl1"),
                col("TDUL2").alias("dl2"),
                col("TDUL3").alias("dl3"),
            )
    }
}
